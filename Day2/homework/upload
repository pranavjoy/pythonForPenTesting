import socket
import threading
import subprocess


def ClientHandler(clientSocket, addr):
    while True:
        client_data = clientSocket.recv(2048)
        if client_data:
            clientSocket.send(client_data)
        else:
            clientSocket.close()
            return

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.bind(("0.0.0.0", 42069))
s.listen(2)
(client, (ip, port)) = s.accept()
print(f'Got connection from {ip}')

while True:
    thread = threading.Thread(target=ClientHandler, args=(client, ip))
    thread.start()

    directory = subprocess.check_output(['pwd', '-L']).decode("utf-8").replace("\n", "")
    cmd = input('> ')

    if cmd.split(' ')[0] == "download":
        client.send(cmd.encode())
        response = client.recv(2048)
        if response.decode('utf-8') == "ERROR":
            print("Something went wrong")
        else:
            print("Starting download \n")
            directory = subprocess.check_output(['pwd', '-L']).decode("utf-8").replace("\n", "")
            f = open(directory + "/download", 'ab')
            f.write(response)
            f.close()
            print("Download complete! See your file at" + directory + "/download \n")

    elif cmd.split(' ')[0] == "upload":
        param = cmd.split(' ')[1]
        existencePayload = "ls | grep -i " + param
        existence = subprocess.check_output(existencePayload, shell=True).decode("utf-8").replace("\n", "")
        if existence != "":
            filename = directory + "/" + existence
            with open(filename, "rb") as f:
                byte = f.read()
                while byte:
                    client.send(byte)
                    response = client.recv(2048)


import socket
import threading
import subprocess


def client_handler(clientSocket, addr):
    directory = subprocess.check_output(['pwd', '-L']).decode("utf-8").replace("\n", "")
    cmd = input('> ')

    if cmd.split(' ')[0] == "download":
        client.send(cmd.encode())
        response = client.recv(2048)
        if response.decode('utf-8') == "ERROR":
            print("Something went wrong")
        else:
            print("Starting download \n")
            directory = subprocess.check_output(['pwd', '-L']).decode("utf-8").replace("\n", "")
            f = open(directory + "/download", 'ab')
            f.write(response)
            f.close()
            print("Download complete! See your file at" + directory + "/download \n")
        cmd = input('> ')

    elif cmd.split(' ')[0] == "upload":
        param = cmd.split(' ')[1]
        existencePayload = "ls | grep -i " + param
        existence = subprocess.check_output(existencePayload, shell=True).decode("utf-8").replace("\n", "")
        if existence != "":
            filename = directory + "/" + existence
            with open(filename, "rb") as f:
                byte = f.read()
                while byte:
                    client.send(byte)
                    response = client.recv(2048)
        else:
            print("File does not exist")
    else:
        print("Incorrect command entered")


s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.bind(("0.0.0.0", 42069))
s.listen(2)

while True:
    (client, (ip, port)) = s.accept()
    print(f'Got connection from {ip}')
    thread = threading.Thread(target=client_handler, args=(client, ip))
    thread.start()
